---
name: "Build Image and upload to ghcr"
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    steps:
    - uses: actions/checkout@v4
    - uses: gacts/install-podman@v1
    - uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    - name: Build container image
      id: build_image
      run: |
        uname -a

        nix build .#iglu-cache-docker
        podman load < result

        version=$(podman images | grep iglu-cache-docker | head -n1 | awk '{print $2}')
        arch=$(podman images | grep iglu-cache-docker | head -n1 | awk '{print $2}' | cut -d- -f2)

        echo "version=$version" >> $GITHUB_OUTPUT
        echo "arch=$arch" >> $GITHUB_OUTPUT

        podman image tag iglu-cache-docker:$version iglu-cache-docker:latest-$arch 
    - name: Push To GHCR
      uses: redhat-actions/push-to-registry@v2.8
      with:
        image: iglu-cache-docker  
        tags: ${{ steps.build_image.outputs.version }} latest-${{ steps.build_image.outputs.arch }}
        registry: ghcr.io/${{ github.repository_owner }}
        username: ${{ github.actor }} 
        password: ${{ secrets.GITHUB_TOKEN }}
        extra-args: |
          --disable-content-trust

