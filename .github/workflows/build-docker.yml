---
name: "Build Image and upload to ghcr"
on:
  push:
    branches:
      - main
  workflow_dispatch:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v31
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    - name: Build container image
      id: build_image
      run: |
        nix build .#iglu-cache-docker
        nix-env -iA nixos.docker
        docker load < result
        echo version=$(docker images | grep iglu-cache-docker | awk '{print $2}') >> "$GITHUB_OUTPUT"
        docker image tag $(docker images | grep iglu-cache-docker | awk '{print $3}') iglu-cache-docker:latest 
    - name: Push To GHCR
      uses: redhat-actions/push-to-registry@v2.8
      with:
        image: iglu-cache-docker  
        tags: ${{ steps.build_image.outputs.version }} latest
        registry: ghcr/iglu-api
        username: ${{ github.actor }} 
        password: ${{ github.token }}
        extra-args: |
          --disable-content-trust

